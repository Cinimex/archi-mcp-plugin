 ### План: Синхронизация MCP инструментов с OpenAPI методами (feature-plan 002)

## Цель
- Привести в полное соответствие реализацию MCP инструментов (JsonRPCHandler) с методами OpenAPI спецификации
- Устранить выявленные расхождения в параметрах и типах данных
- Добавить недостающие MCP инструменты для полного покрытия REST API

## Контекст/Предпосылки
- Текущее покрытие: 24 из 27 OpenAPI методов (89%)
- Отсутствуют MCP инструменты для скриптовых методов и OpenAPI спецификации
- Несоответствие типов данных в параметре `log` метода `search`
- Различные форматы возврата изображений (binary vs base64)
- Общая архитектура с единым Core слоем работает корректно

## Инварианты
- Локальный сервер, только `127.0.0.1`; порт — как в `Config.resolvePort()`.
- Операции с EMF/SWT — через `Display.getDefault().syncExec(...)`.
- Источник правды REST‑контракта — `resources/openapi.json`.
- Тесты — в `ru.cinimex.archimatetool.mcp/test`.
- MCP инструменты используют тот же Core слой, что и REST API
- Валидация параметров через ToolParam с ограничениями maxItems=50
- JSON-RPC 2.0 коды ошибок мапятся на CoreException типы

## Целевая архитектура 

### Аспект архитектуры 1: Полное покрытие API
- Каждый OpenAPI метод имеет соответствующий MCP инструмент
- Одинаковая функциональность через REST и JSON-RPC интерфейсы
- Консистентные параметры и типы данных

### Аспект архитектуры 2: Унифицированные типы данных
- Параметр `log` в методе `search` использует enum вместо boolean
- Стандартизированный формат возврата изображений
- Совместимые схемы валидации параметров

### Аспект архитектуры 3: Расширенная функциональность
- MCP инструменты для скриптовых операций
- Доступ к OpenAPI спецификации через MCP
- Полная интеграция с ScriptingCore

## Ведение прогресса по шагам (скопировать в план целиком)
- Для каждого шага поддерживать чек‑лист:
  - Статус: [done|partial|todo]
  - Сделано: краткий перечень завершённых подпунктов
  - Осталось: оставшиеся подпункты/блокеры/владелец (если есть)
- Если шаг выполнен, агент сразу переходит к следующему до полного завершения плана.

## Шаги реализации
⚠️ Важно: все шаги должны выполняться **последовательно и без остановок**, пока не завершится весь план. Если после выполнения одного шага остаются следующие, агент обязан перейти к ним автоматически, без ожидания подтверждения пользователя.

1) - Перенести валидацию параметров из ScriptRunHttpHandler в ScriptingCore.run()
   - Перевести валидацию на стандартные валидаторы из core.validation.Validators
   - Статус: [done]
   - Сделано: валидация вынесена в ScriptingCore.run с использованием Validators, реализована нормализация параметров
   - Осталось: —
   

2) **Добавление MCP инструмента `list_script_engines`**
   - Создать новый Tool в ToolRegistry с именем `list_script_engines`. Добавить описания параметров аналогичные OpenAPI спецификации.
   - Подключить ScriptingCore для получения списка движков
   - Добавить описание и пустой список параметров
   - Протестировать возврат данных в формате, совместимом с REST API
   - Статус: [done]
   - Сделано: добавлен инструмент в ToolRegistry, возвращает установленность и список движков с документацией
   - Осталось: —

3) **Добавление MCP инструмента `run_script`**
   - Создать Tool с параметрами: engine, code, timeout_ms, bindings, model_id, log. Добавить описания параметров аналогичные OpenAPI спецификации.
   - Настроить валидацию параметров через ToolParam
   - Реализовать вызов ScriptingCore.runScript() с преобразованием параметров
   - Обеспечить совместимость с REST API форматом ответа
   - Статус: [done]
   - Сделано: реализован инструмент с маппингом параметров на ScriptRequest, добавлена проверка bindings и формирование ответа
   - Осталось: —

4) **Обновление тестов**
   - Добавить тесты для новых MCP инструментов в JsonRpcHttpHandlerTest
   - Обновить smoke тесты для проверки новой функциональности
   - Проверить совместимость параметров между REST и MCP
   - Добавить тесты для обработки ошибок
   - Статус: [done]
   - Сделано: добавлены юнит-тесты для MCP инструментов, обновлен smoke-сценарий для REST скриптовых маршрутов
   - Осталось: —


## DoD (Definition of Done)
- Все OpenAPI методы, кроме OpenAPI-специфичных, имеют соответствующие MCP инструменты (100% покрытие)
- Параметры и типы данных полностью совместимы между REST и MCP
- Добавлены юнит-тесты для новых MCP инструментов
- Smoke тесты проходят для всех новых инструментов
- Обновлена документация с примерами использования
- Нет регрессий в существующей функциональности

## Тестирование
- Юнит‑тесты: JsonRpcHttpHandlerTest для новых инструментов, валидация параметров (расположение: `ru.cinimex.archimatetool.mcp/test`).
- Интеграционные/smoke: обновленный test_smoke.py с проверкой скриптовых методов и OpenAPI через MCP.
